// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Organisation {
  id   String @id
  name String
  slug String @unique

  agents    Agent[]
  sessions  AgentSession[]
  messages  AgentMessage[]
  variables AgentVariable[]

  @@map("organisations")
}

model Agent {
  id             String   @id
  organisationId String   @map("organisation_id")
  name           String
  slug           String   @unique
  description    String?
  model          String   @unique
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organisation Organisation  @relation(fields: [organisationId], references: [id])
  sessions     AgentSession[]

  @@index([slug])
  @@map("agents")
}

model AgentSession {
  id             String   @id
  organisationId String   @map("organisation_id")
  agentId        String   @map("agent_id")
  createdAt      DateTime @default(now()) @map("created_at")

  organisation Organisation  @relation(fields: [organisationId], references: [id])
  agent        Agent         @relation(fields: [agentId], references: [id])
  messages     AgentMessage[]
  variables    AgentVariable[]

  @@index([agentId])
  @@map("agent_sessions")
}

model AgentMessage {
  id             String   @id
  organisationId String   @map("organisation_id")
  sessionId      String   @map("session_id")
  role           String
  sequenceId     Int      @map("sequence_id")
  content        Json?
  variables      Json?
  createdAt      DateTime @default(now()) @map("created_at")

  organisation Organisation @relation(fields: [organisationId], references: [id])
  session      AgentSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
  @@map("agent_messages")
}

model AgentVariable {
  id             String   @id
  organisationId String   @map("organisation_id")
  sessionId      String   @map("session_id")
  name           String
  value          Json?
  createdAt      DateTime @default(now()) @map("created_at")

  organisation Organisation @relation(fields: [organisationId], references: [id])
  session      AgentSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
  @@map("agent_variables")
}
