// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum AgentMessageRole {
  user
  agent
}

enum UserStatus {
  active
  inactive
}

model Organisation {
  id   String @id
  name String
  slug String @unique

  agents   Agent[]
  sessions AgentSession[]
  messages AgentMessage[]
  users    User[]

  @@map("organisations")
}

model User {
  id             String      @id
  organisationId String      @map("organisation_id")
  name           String
  email          String      @unique
  password       String      @map("password")
  status         UserStatus
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  verifiedAt     DateTime?   @map("verified_at")

  organisation   Organisation @relation(fields: [organisationId], references: [id])

  @@map("users")
}

model Agent {
  id             String   @id
  organisationId String   @map("organisation_id")
  name           String
  slug           String   @unique
  model          String   @unique
  description    String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organisation Organisation   @relation(fields: [organisationId], references: [id])
  sessions     AgentSession[]

  @@index([slug])
  @@map("agents")
}

model AgentSession {
  id             String   @id
  organisationId String   @map("organisation_id")
  agentId        String   @map("agent_id")
  createdAt      DateTime @default(now()) @map("created_at")

  organisation Organisation   @relation(fields: [organisationId], references: [id])
  agent        Agent          @relation(fields: [agentId], references: [id])
  messages     AgentMessage[]

  @@index([agentId])
  @@map("agent_sessions")
}

model AgentMessage {
  id             String           @id
  organisationId String           @map("organisation_id")
  sessionId      String           @map("session_id")
  role           AgentMessageRole
  sequenceId     Int              @map("sequence_id")
  content        Json?
  createdAt      DateTime         @default(now()) @map("created_at")

  organisation Organisation @relation(fields: [organisationId], references: [id])
  session      AgentSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
  @@map("agent_messages")
}
